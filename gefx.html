<meta charset="utf-8">
<title>Graphe</title>

<style>
//	svg { background: lightyellow; }
	circle:hover { stroke: black; z-index: 1; }
	polyline { marker-mid: url(#arrow); fill:none; stroke: darkgrey; }
	#arrow { fill:darkgrey; stroke: darkgrey; }
	#arrow:hover { fill:black; stroke: black; }
</style>

<script id="api">
var arrowPosition = .618;
function createNode(id){
	var node = document.createElementNS("http://www.w3.org/2000/svg", 'circle');
	node.setAttribute('onmousedown', "mousedown(event)");
	node.setAttribute('onwheel', "wheel(event)");
	node.setAttribute('cx', "100");
	node.setAttribute('cy', "100");
	node.setAttribute('r', "10");
	node.setAttribute('stroke', "darkgrey");
	node.setAttribute('stroke-width', "1");
	node.setAttribute('fill', "url('#blue')");
	node.id = id ? id : new Date().getTime();
	var svg = document.querySelector('#svg_nodes');
	svg.append(node);
	return node;
}
function copyNode(proto){
	var node = proto.cloneNode(true);
	Object.assign(node, proto);
	node.id = new Date().getTime();
	var svg = document.querySelector('#svg_nodes');
	svg.insertBefore(node, svg.firstChild);
	return node;
}
function moveNode(node, x, y){
	var screen = document.querySelector('svg').getBoundingClientRect();
	node.setAttribute('cx', x);
	node.setAttribute('cy', y);
	drawEdges();
}
function removeNode(node){
	for(var edge of document.querySelectorAll('#svg_edges [source="'+node.id+'"]'))
		removeEdge(edge);
	for(var edge of document.querySelectorAll('#svg_edges [target="'+node.id+'"]'))
		removeEdge(edge);
	node.parentElement.removeChild(node);
}
function setNodeSize(node, r){
	node.setAttribute('r', r);
}
function getNodeSize(node){
	return Number(node.getAttribute('r'));
}

function createEdge(source, target){
	var edge = document.createElementNS("http://www.w3.org/2000/svg", 'polyline');
	edge.id = new Date().getTime();
	edge.setAttribute("source", source);
	edge.setAttribute("target", target);
	document.querySelector('#svg_edges').appendChild(edge);
	var mouse = document.createElementNS("http://www.w3.org/2000/svg", 'use');
	mouse.setAttribute('href', '#'+edge.id);
	mouse.setAttribute('onclick', "clickArrow(this)");
	document.querySelector('#svg_edges').appendChild(mouse);
	drawEdges();
}
function removeEdge(edge){
	edge.parentElement.removeChild(edge);
}

function clear(){
	for(var node of document.querySelectorAll('#svg_nodes circle:not(.prototype)'))
		removeNode(node);
}

function drawEdges(){
	for(var edge of document.querySelectorAll('polyline')){
		var source = document.getElementById(edge.getAttribute('source'));
		var target = document.getElementById(edge.getAttribute('target'));
		var x1 = source.getAttribute('cx');
		var y1 = source.getAttribute('cy');
		var x3 = target.getAttribute('cx');
		var y3 = target.getAttribute('cy');
		var x2 = (1-arrowPosition)*x1 + arrowPosition*x3;
		var y2 = (1-arrowPosition)*y1 + arrowPosition*y3;
		
		var points = x1+','+y1+' '+x2+','+y2+' '+x3+','+y3;
		edge.setAttribute("points", points);
	}
}
loadFile = function(file){
	var f = new FileReader();
	f.onload = function(event){
		parser = new DOMParser();
		xml = parser.parseFromString(f.result, "text/xml");
		console.log(xml);
		clear();
		var xMin = Infinity;
		var xMax = -Infinity;
		var yMin = Infinity;
		var yMax = -Infinity;
		for(var n of xml.querySelectorAll('node')){
			var pos = n.querySelector('position');
			var x = Number(pos.getAttribute('x'));
			var y = Number(pos.getAttribute('y'));
			if(x<xMin) xMin = x;
			if(x>xMax) xMax = x;
			if(y<yMin) yMin = y;
			if(y>yMax) yMax = y;
		}
		var scr = document.querySelector('svg').getBoundingClientRect();
		for(var n of xml.querySelectorAll('node')){
			var node = createNode(n.id);
			setNodeSize(node, n.querySelector('size').getAttribute('value'));
			var pos = n.querySelector('position');
			var x = Number(pos.getAttribute('x'));
			var y = Number(pos.getAttribute('y'));
			x = ((x-xMin)/(xMax-xMin) *.8 +.1 ) *scr.width +scr.left;
			y = ((y-yMin)/(yMax-yMin) *.8 +.1 ) *scr.height +scr.top;
			moveNode(node, x, y);
		}
		for(var e of xml.querySelectorAll('edge')){
			createEdge(e.getAttribute('source'), e.getAttribute('target'));
		}
		document.title = file.name.replace(/\.[^\.]*$/, '');
	}
	f.readAsText(file);
}
saveFile = function(){
	var xml = '<?xml version="1.0" encoding="UTF-8"?>\n';
	xml += '<gexf xmlns="http://www.gexf.net/1.3" version="1.3" xmlns:viz="http://www.gexf.net/1.3/viz" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.gexf.net/1.3 http://www.gexf.net/1.3/gexf.xsd">\n';
	xml += '<meta lastmodifieddate="'+new Date().toISOString().substr(0,10)+'">\n';
    xml += '    <creator></creator>\n';
    xml += '    <description></description>\n';
	xml += '</meta>\n';
	
	xml += '<nodes>\n';
	for(var node of document.querySelectorAll('#svg_nodes circle:not(.prototype)')){
		xml += '    <node id="'+node.id+'">\n';
		xml += '      <viz:size value="'+node.getAttribute('r')+'"></viz:size>\n';
		xml += '      <viz:position x="'+node.getAttribute('cx')+'" y="'+node.getAttribute('cy')+'"></viz:position>\n';
		xml += '    </node>\n';
	}
	xml += '</nodes>\n';

	var edge_id = 0;
	xml += '<edges>\n';
	for(var edge of document.querySelectorAll('#svg_edges polyline'))
		xml += '<edge id="'+(edge_id++)+'" source="'+edge.getAttribute('source')+'" target="'+edge.getAttribute('target')+'"></edge>\n';
	xml += '</edges>\n';
	xml += '</gexf>';

	var link = document.createElement("a");
    link.download = document.title+'.gexf';
    link.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(xml);
    link.click();
}
</script>


<script id="gui">
var drag;
function mousedown(event){
	drag = event.target;
	event.preventDefault();
	if(drag.tagName=="circle"){
		drag.x = drag.getAttribute("cx");
		drag.y = drag.getAttribute("cy");
		drag.dx = event.clientX - drag.x;
		drag.dy = event.clientY - drag.y;
		var nodes = document.querySelector('#svg_nodes');
		nodes.insertBefore(drag, nodes.firstChild);
	}
}
onmousemove = (event) => {
	if(drag){
		if(drag.classList.contains("prototype")){
			drag = copyNode(drag);
			drag.classList.remove('prototype');
		}
		moveNode(drag, event.clientX-drag.dx, event.clientY-drag.dy);
	}
}
onmouseup = (event) => {
	// TODO: May be called for nodes out of the board
	if(drag && event.target && drag!=event.target){
		createEdge(event.target.id, drag.id);
		moveNode(drag, drag.x, drag.y);
	}
	drag = null;
}
function cutArrow(event){
	if(!drag)
		console.log(!drag, event);
}
function clickArrow(event){
	console.log(!drag, event);
}
function wheel(event){
	var node = event.target;
	if(!node.classList.contains('prototype'))
		setNodeSize(node, (1+event.deltaY/25)*getNodeSize(node));
}
onload = function(){
	var svg = document.querySelector('svg');
	svg.addEventListener("dragenter", function(e) { e.stopPropagation(); e.preventDefault(); }, false);
	svg.addEventListener("dragover", function(e) { e.stopPropagation(); e.preventDefault(); }, false);
	svg.addEventListener("drop", function(e){ e.stopPropagation(); e.preventDefault(); loadFile(e.dataTransfer.files[0]);}, false);
}
onkeydown = function(event){
	event.preventDefault();
	if(event.ctrlKey && event.key=='s')
		saveFile();
}
</script>

<svg width="100%" height="100%">
	<radialGradient id="blue" cx="50%" cy="50%" r="50%" fx="70%" fy="30%">
		<stop offset="0%"   stop-color="white"  stop-opacity="100%"/>
		<stop offset="80%" stop-color="#b3cde3" stop-opacity="100%"/>
	</radialGradient>

	<radialGradient id="green" cx="50%" cy="50%" r="50%" fx="70%" fy="30%">
		<stop offset="0%"   stop-color="white"  stop-opacity="100%"/>
		<stop offset="80%" stop-color="#ccebc5" stop-opacity="100%"/>
	</radialGradient>

	<radialGradient id="yellow" cx="50%" cy="50%" r="50%" fx="70%" fy="30%">
		<stop offset="0%"   stop-color="white"  stop-opacity="100%"/>
		<stop offset="80%" stop-color="#ffffcc" stop-opacity="100%"/>
	</radialGradient>

	<radialGradient id="orange" cx="50%" cy="50%" r="50%" fx="70%" fy="30%">
		<stop offset="0%"   stop-color="white"  stop-opacity="100%"/>
		<stop offset="80%" stop-color="#fed9a6" stop-opacity="100%"/>
	</radialGradient>

	<radialGradient id="red" cx="50%" cy="50%" r="50%" fx="70%" fy="30%">
		<stop offset="0%"   stop-color="white"  stop-opacity="100%"/>
		<stop offset="80%" stop-color="#fbb4ae" stop-opacity="100%"/>
	</radialGradient>

	<radialGradient id="purple" cx="50%" cy="50%" r="50%" fx="70%" fy="30%">
		<stop offset="0%"   stop-color="white"  stop-opacity="100%"/>
		<stop offset="80%" stop-color="#decbe4" stop-opacity="100%"/>
	</radialGradient>

	<radialGradient id="grey" cx="50%" cy="50%" r="50%" fx="70%" fy="30%">
		<stop offset="0%"   stop-color="white"  stop-opacity="100%"/>
		<stop offset="80%" stop-color="#e6e6e6" stop-opacity="100%"/>
	</radialGradient>
	
	<defs>
		<marker id="arrow" viewBox="0 0 12 14" refX="0" refY="4" markerWidth="12" markerHeight="16" orient="auto">
			<path d="M0,0 L12,4 L0,8 z" />
		</marker>
	</defs>

	<g id="svg_edges"></g>

	<g id="svg_nodes">
		<circle class="prototype" onmousedown="mousedown(event)" onwheel="wheel(event)" cx="11" cy="11"  r="10" stroke="darkgrey" stroke-width="1" fill="url('#blue')" />
		<circle class="prototype" onmousedown="mousedown(event)" onwheel="wheel(event)" cx="11" cy="36"  r="10" stroke="darkgrey" stroke-width="1" fill="url('#green')" />
		<circle class="prototype" onmousedown="mousedown(event)" onwheel="wheel(event)" cx="11" cy="61"  r="10" stroke="darkgrey" stroke-width="1" fill="url('#yellow')" />
		<circle class="prototype" onmousedown="mousedown(event)" onwheel="wheel(event)" cx="11" cy="86"  r="10" stroke="darkgrey" stroke-width="1" fill="url('#orange')" />
		<circle class="prototype" onmousedown="mousedown(event)" onwheel="wheel(event)" cx="11" cy="111" r="10" stroke="darkgrey" stroke-width="1" fill="url('#red')" />
		<circle class="prototype" onmousedown="mousedown(event)" onwheel="wheel(event)" cx="11" cy="136" r="10" stroke="darkgrey" stroke-width="1" fill="url('#purple')" />
		<circle class="prototype" onmousedown="mousedown(event)" onwheel="wheel(event)" cx="11" cy="161" r="10" stroke="darkgrey" stroke-width="1" fill="url('#grey')" />
	</g>
</svg>
