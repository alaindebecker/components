<meta charset="utf-8">

<style>
//	svg { background: lightyellow; }

	circle:hover { stroke: black; z-index: 1; }
	polyline { marker-mid: url(#arrow); fill:none; stroke: darkgrey; }
	#arrow { fill:darkgrey; stroke: darkgrey; }
	#arrow:hover { fill:black; stroke: black; }

</style>

<script id="api">
var arrowPosition = .618;

function copyNode(proto){
	var node = proto.cloneNode(true);
	Object.assign(node, proto);
	node.id = new Date().getTime();
	document.querySelector('svg').append(node);
	return node;
}
function moveNode(node, x, y){
	//TODO: Check if stay on board
	var screen = document.querySelector('svg').getBoundingClientRect();
	if(screen.left<x && x<screen.right)
		node.setAttribute('cx', x);
	if(screen.top<y && y<screen.bottom)
		node.setAttribute('cy', y);
	drawEdges();
}
function createEdge(source, target){
	console.log(source, target);
	var edge = document.createElementNS("http://www.w3.org/2000/svg", 'polyline');
	edge.id = new Date().getTime();
	edge.setAttribute("source", source.id);
	edge.setAttribute("target", target.id);
	document.querySelector('#svg_edges').appendChild(edge);

	var mouse = document.createElementNS("http://www.w3.org/2000/svg", 'use');
	mouse.setAttribute('href', '#'+edge.id);
	mouse.setAttribute('onclick', "clickArrow(this)");
	document.querySelector('#svg_edges').appendChild(mouse);
	drawEdges();
}
function drawEdges(){
	for(var edge of document.querySelectorAll('polyline')){
		var source = document.getElementById(edge.getAttribute('source'));
		var target = document.getElementById(edge.getAttribute('target'));
		var x1 = source.getAttribute('cx');
		var y1 = source.getAttribute('cy');
		var x3 = target.getAttribute('cx');
		var y3 = target.getAttribute('cy');
		var x2 = (1-arrowPosition)*x1 + arrowPosition*x3;
		var y2 = (1-arrowPosition)*y1 + arrowPosition*y3;
		
		var points = x1+','+y1+' '+x2+','+y2+' '+x3+','+y3;
		edge.setAttribute("points", points);
	}
}
</script>


<script id="gui">
var drag;
function mousedown(event){
	drag = event.target;
	event.preventDefault();
	if(drag.tagName=="circle"){
		drag.x = drag.getAttribute("cx");
		drag.y = drag.getAttribute("cy");
		drag.dx = event.clientX - drag.x;
		drag.dy = event.clientY - drag.y;
		var nodes = document.querySelector('#svg_nodes');
		nodes.insertBefore(drag, nodes.firstChild);
	}
}
onmousemove = (event) => {
	if(drag){
		if(drag.classList.contains("prototype")){
			drag = copyNode(drag);
			drag.classList.remove('prototype');
		}
		moveNode(drag, event.clientX-drag.dx, event.clientY-drag.dy);
	}
}
onmouseup = (event) => {
	// TODO: May be called foe nodes out of the board
	if(drag && event.target && drag!=event.target){
		createEdge(event.target, drag);
		moveNode(drag, drag.x, drag.y);
	}
	drag = null;
}
function cutArrow(event){
	if(!drag)
		console.log(!drag, event);
}
function clickArrow(event){
	console.log(!drag, event);
}
</script>

<svg width="100%" height="100%">
	<radialGradient id="blue" cx="50%" cy="50%" r="50%" fx="70%" fy="30%">
		<stop offset="0%"   stop-color="white"  stop-opacity="100%"/>
		<stop offset="80%" stop-color="#b3cde3" stop-opacity="100%"/>
	</radialGradient>

	<radialGradient id="green" cx="50%" cy="50%" r="50%" fx="70%" fy="30%">
		<stop offset="0%"   stop-color="white"  stop-opacity="100%"/>
		<stop offset="80%" stop-color="#ccebc5" stop-opacity="100%"/>
	</radialGradient>

	<radialGradient id="yellow" cx="50%" cy="50%" r="50%" fx="70%" fy="30%">
		<stop offset="0%"   stop-color="white"  stop-opacity="100%"/>
		<stop offset="80%" stop-color="#ffffcc" stop-opacity="100%"/>
	</radialGradient>

	<radialGradient id="orange" cx="50%" cy="50%" r="50%" fx="70%" fy="30%">
		<stop offset="0%"   stop-color="white"  stop-opacity="100%"/>
		<stop offset="80%" stop-color="#fed9a6" stop-opacity="100%"/>
	</radialGradient>

	<radialGradient id="red" cx="50%" cy="50%" r="50%" fx="70%" fy="30%">
		<stop offset="0%"   stop-color="white"  stop-opacity="100%"/>
		<stop offset="80%" stop-color="#fbb4ae" stop-opacity="100%"/>
	</radialGradient>

	<radialGradient id="purple" cx="50%" cy="50%" r="50%" fx="70%" fy="30%">
		<stop offset="0%"   stop-color="white"  stop-opacity="100%"/>
		<stop offset="80%" stop-color="#decbe4" stop-opacity="100%"/>
	</radialGradient>

	<radialGradient id="grey" cx="50%" cy="50%" r="50%" fx="70%" fy="30%">
		<stop offset="0%"   stop-color="white"  stop-opacity="100%"/>
		<stop offset="80%" stop-color="#e6e6e6" stop-opacity="100%"/>
	</radialGradient>
	
	<defs>
		<marker id="arrow" viewBox="0 0 12 14" refX="0" refY="4" markerWidth="12" markerHeight="16" orient="auto">
			<path d="M0,0 L12,4 L0,8 z" />
		</marker>
	</defs>

	<g id="svg_edges"></g>

	<g id="svg_nodes">
		<circle class="prototype" onmousedown="mousedown(event)" cx="11" cy="11"  r="10" stroke="darkgrey" stroke-width="1" fill="url('#blue')" />
		<circle class="prototype" onmousedown="mousedown(event)" cx="11" cy="36"  r="10" stroke="darkgrey" stroke-width="1" fill="url('#green')" />
		<circle class="prototype" onmousedown="mousedown(event)" cx="11" cy="61"  r="10" stroke="darkgrey" stroke-width="1" fill="url('#yellow')" />
		<circle class="prototype" onmousedown="mousedown(event)" cx="11" cy="86"  r="10" stroke="darkgrey" stroke-width="1" fill="url('#orange')" />
		<circle class="prototype" onmousedown="mousedown(event)" cx="11" cy="111" r="10" stroke="darkgrey" stroke-width="1" fill="url('#red')" />
		<circle class="prototype" onmousedown="mousedown(event)" cx="11" cy="136" r="10" stroke="darkgrey" stroke-width="1" fill="url('#purple')" />
		<circle class="prototype" onmousedown="mousedown(event)" cx="11" cy="161" r="10" stroke="darkgrey" stroke-width="1" fill="url('#grey')" />
	</g>
</svg>

